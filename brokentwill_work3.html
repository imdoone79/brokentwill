<!DOCTYPE html><html lang="ko"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Broken Twill — Glass Pulse</title><script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script><style>html,body{height:100%;margin:0;background:#0a0a0a;color:#eaeaea;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Pretendard,Arial,sans-serif}header{position:fixed;inset:16px auto auto 16px;display:flex;gap:10px;z-index:10}.btn{appearance:none;border:1px solid #2a2a2a;background:#141414;color:#eaeaea;padding:10px 12px;border-radius:10px;cursor:pointer}.btn[disabled]{opacity:.5;cursor:not-allowed}#note{position:fixed;right:16px;top:16px;color:#9aa0a6;font-size:12px}main{display:grid;place-items:center;min-height:100vh}canvas{box-shadow:0 0 0 1px #1e1e1e inset;border-radius:12px;background:#0c0c0c}</style></head><body>
<header><button id="startBtn" class="btn">Start 5-min Render</button><button id="previewBtn" class="btn">Preview (no record)</button></header>
<div id="note">Glass Pulse · 1080p · 30fps · WebM(영상+오디오) · 상단 버튼으로 시작</div><main></main>
<script>
const WIDTH=1920, HEIGHT=1080, FPS=30, DURATION_SEC=300, WITH_AUDIO=true; const CYCLE_MEAN=2.5, CYCLE_JITTER=0.6;
let gfx, frameAbs=0, totalFrames=DURATION_SEC*FPS, running=false, recording=false, previewOnly=false;
let cycleStart=0, cycleLen=CYCLE_MEAN, cycleIdx=0, crackRegions=[];
let master, filterHF, breakBus, breakMeter, seq, burst; let mediaRecorder, recordedChunks=[], canvasElement;
function smoothstep(e0,e1,x){ const t=Math.min(1,Math.max(0,(x-e0)/(e1-e0))); return t*t*(3-2*t); }
function beginCycle(t0){ cycleStart=t0; cycleLen=Math.max(1.6,CYCLE_MEAN+(Math.random()*2-1)*CYCLE_JITTER); cycleIdx++; crackRegions=[]; const n=Math.floor(3+Math.random()*4); for(let i=0;i<n;i++) crackRegions.push({cx:Math.random()*WIDTH,cy:Math.random()*HEIGHT,r:Math.min(WIDTH,HEIGHT)*(0.08+Math.random()*0.18),k:0.5+Math.random()*0.6}); if(WITH_AUDIO&&burst&&Tone.Transport.state==="started"){ const mid0=cycleStart+cycleLen*0.45, mid1=cycleStart+cycleLen*0.55; const span=Math.min(0.6,Math.max(0.3,cycleLen*0.25)); for(let t=mid0;t<mid1;t+=Tone.Time("16t").toSeconds()*(0.8+Math.random()*0.6)){ Tone.Transport.schedule(burst,t+Math.random()*span*0.5);} } }
function updateCycle(tNow){ if(tNow===0&&cycleIdx===0) beginCycle(0); while(tNow>=cycleStart+cycleLen) beginCycle(cycleStart+cycleLen); }
function cycleUnstableAmount(tNow){ const u=(tNow-cycleStart)/cycleLen, atk=0.35, rel=0.65; const e=u<atk?Math.pow(u/atk,1.6):(u>rel?Math.pow((1-u)/(1-rel),0.9):1.0); return Math.max(0,Math.min(1,e)); }
async function setupAudio(){ await Tone.start(); Tone.Transport.cancel(0); Tone.Transport.bpm.value=96; master=new Tone.Gain(1.0);
  breakBus=new Tone.Gain(0).toDestination(); filterHF=new Tone.Filter(2500,"highpass").connect(breakBus); breakMeter=new Tone.Meter({channels:1,smoothing:0.7}); breakBus.connect(breakMeter);
  /* === Glass Pulse === */ const bell=new Tone.FMSynth({modulationIndex:8,harmonicity:1.5,envelope:{attack:0.005,decay:0.2,sustain:0,release:0.12}}).connect(new Tone.Reverb({decay:0.8,preDelay:0.02}).connect(master));
  const motif=["C4","G3","A3","E3","D3","G3","B3","A3"]; seq=new Tone.Sequence((time,n)=>bell.triggerAttackRelease(n,"8n",time),motif,"8n").start(0);
  const sh=new Tone.Noise("white").start(); const bp=new Tone.Filter(4200,"bandpass").connect(filterHF);
  const env=new Tone.AmplitudeEnvelope({attack:0.001,decay:0.06,sustain:0,release:0.05}).connect(bp); sh.connect(env);
  burst=(time)=>{ bp.frequency.rampTo(5200,0.04); env.triggerAttackRelease("16n",time); };
  if(WITH_AUDIO){ const dest=Tone.getContext().rawContext.createMediaStreamDestination(); master.connect(Tone.getContext().destination); master.connect(dest); window.__audioStream=dest.stream; } Tone.Transport.start("+0.1"); }
function startRecording(){ const canvasStream=canvasElement.captureStream(FPS); const combined=(WITH_AUDIO&&window.__audioStream)?new MediaStream([...canvasStream.getVideoTracks(),...window.__audioStream.getAudioTracks()]):canvasStream; recordedChunks=[]; let mr; try{mr=new MediaRecorder(combined,{mimeType:"video/webm;codecs=vp9,opus"});}catch(e){mr=new MediaRecorder(combined);} mediaRecorder=mr; mediaRecorder.ondataavailable=(e)=>{ if(e.data.size>0) recordedChunks.push(e.data); }; mediaRecorder.onstop=saveRecording; mediaRecorder.start(); recording=true; }
function stopRecording(){ if(mediaRecorder&&recording) mediaRecorder.stop(); recording=false; }
function saveRecording(){ const blob=new Blob(recordedChunks,{type:"video/webm"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="broken_twill_5min_glass.webm"; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},800); }
function setup(){ frameRate(FPS); const cnv=createCanvas(WIDTH,HEIGHT); canvasElement=cnv.canvas; cnv.parent(document.querySelector('main')); gfx=createGraphics(WIDTH,HEIGHT); noSmooth(); }
function draw(){ if(!running) return; const t=frameAbs/FPS; updateCycle(t); let audioBurstLevel=0.0; if(breakMeter) audioBurstLevel=Math.min(1,Math.max(0,(breakMeter.getValue()+30)/20)); const unstable=cycleUnstableAmount(t), breakIntensity=Math.min(1,0.75*unstable+0.25*audioBurstLevel); const order=0.2+0.6*(1-breakIntensity), warm=0.1+0.7*unstable, jitter=0.02+0.22*breakIntensity; renderBrokenTwill(gfx,{order,warm,jitter,breakIntensity,unstable,regions:crackRegions}); image(gfx,0,0,WIDTH,HEIGHT); if(t>=(DURATION_SEC-2)){ const u=(t-(DURATION_SEC-2))/2; noStroke(); fill(0,255*Math.min(1,u)); rect(0,0,WIDTH,HEIGHT);} frameAbs++; if(frameAbs>=totalFrames){ running=false; if(recording) stopRecording(); if(Tone.Transport.state==="started") Tone.Transport.stop(); noLoop(); } }
function renderBrokenTwill(g,P){ const {order,warm,jitter,breakIntensity,unstable,regions=[]}=P; g.push(); g.clear(); g.colorMode(HSB,360,100,100,1); const cellBase=16, cell=cellBase*(1.0+0.35*breakIntensity); const cols=Math.ceil(WIDTH/cell)+2, rows=Math.ceil(HEIGHT/cell)+2; const hueBase=lerp(210,18,warm), satBase=lerp(20,60,Math.min(1,warm*0.75)), briBase=88+8*warm; for(let r=0;r<rows;r++){ const flipPeriod=Math.max(1,Math.round(8*order)); const dir=(r%flipPeriod)<1?1:-1; for(let c=0;c<cols;c++){ const jx=randomGaussian()*jitter*8, jy=randomGaussian()*jitter*8, x=c*cell+jx, y=r*cell+jy, warpTop=((c+dir*r)%2)===0; const hueJ=(noise(c*0.11,r*0.13)-0.5)*20, H=(hueBase+hueJ+360)%360, S=satBase*(warpTop?1:0.9), B=briBase*(warpTop?1:0.92); let regionW=0; if(regions.length){ let best=0; for(const R of regions){ const dx=(x+cell*0.5)-R.cx, dy=(y+cell*0.5)-R.cy; const d=Math.hypot(dx,dy); const w=(1-smoothstep(R.r*0.6,R.r,d))*R.k; if(w>best) best=w; } regionW=best; } const localBreak=breakIntensity*(0.35+0.65*regionW), thresh=0.4*(0.5+0.5*localBreak), nseed=noise(c*0.07,r*0.07,frameAbs*0.005), doBreak=(nseed<thresh); if(!doBreak){ const w=warpTop?cell*0.92:cell, h=warpTop?cell:cell*0.92; gradRect(g,x,y,w,h,Math.min(w,h)*0.22,H,S,B,0.92,warpTop?'h':'v'); }else{ g.noFill(); g.stroke(H,S*0.7,B*0.9,0.35); g.strokeWeight(1); g.rect(x+2,y+2,cell-4,cell-4,(cell-4)*0.22); } } } if(unstable>0.65&&(frameAbs%23)<2) g.copy(g,0,0,WIDTH,HEIGHT,random(-8,8),random(-8,8),WIDTH,HEIGHT); g.pop(); }
function gradRect(g,x,y,w,h,r,H,S,B,A,mode){ const ctx=g.drawingContext; const gx0=x,gy0=y,gx1=(mode==='h')?x+w:x,gy1=(mode==='h')?y:y+h; const c0=hsbToRgba(H,S,B,A), c1=hsbToRgba(H,S,B*0.88,A*0.25); const grad=ctx.createLinearGradient(gx0,gy0,gx1,gy1); grad.addColorStop(0,c0); grad.addColorStop(1,c1); ctx.save(); ctx.beginPath(); if(typeof ctx.roundRect==='function') ctx.roundRect(x,y,w,h,r); else { const rr=Math.min(r,Math.min(w,h)/2); ctx.moveTo(x+rr,y); ctx.lineTo(x+w-rr,y); ctx.arc(x+w-rr,y+rr,rr,-Math.PI/2,0); ctx.lineTo(x+w,y+h-rr); ctx.arc(x+w-rr,y+h-rr,rr,0,Math.PI/2); ctx.lineTo(x+rr,y+h); ctx.arc(x+rr,y+h-rr,rr,Math.PI/2,Math.PI); ctx.lineTo(x,y+rr); ctx.arc(x+rr,y+rr,rr,Math.PI,1.5*Math.PI);} ctx.fillStyle=grad; ctx.fill(); ctx.restore(); }
function hsbToRgba(h,s,b,a){ s/=100; b/=100; const C=b*s, hh=(h/60)%6, X=C*(1-Math.abs(hh%2-1)); let r=0,g=0,bl=0; if(0<=hh&&hh<1){r=C;g=X;} else if(1<=hh&&hh<2){r=X;g=C;} else if(2<=hh&&hh<3){g=C;bl=X;} else if(3<=hh&&hh<4){g=X;bl=C;} else if(4<=hh&&hh<5){r=X;bl=C;} else {r=C;bl=X;} const m=b-C; r=Math.round((r+m)*255); g=Math.round((g+m)*255); bl=Math.round((bl+m)*255); return `rgba(${r},${g},${bl},${a})`; }
const startBtn=document.getElementById('startBtn'), previewBtn=document.getElementById('previewBtn');
startBtn.addEventListener('click', async ()=>{ if(running) return; previewOnly=false; await Tone.start(); await setupAudio(); startRecording(); startRun(); });
previewBtn.addEventListener('click', async ()=>{ if(running) return; previewOnly=true; await Tone.start(); await setupAudio(); startRun(); });
function startRun(){ running=true; recording=!previewOnly; frameAbs=0; cycleIdx=0; cycleStart=0; loop(); startBtn.disabled=true; previewBtn.disabled=true; }
function randomGaussian(){ let u=0,v=0; while(u===0)u=Math.random(); while(v===0)v=Math.random(); return Math.sqrt(-2.0*Math.log(u))*Math.cos(2.0*Math.PI*v); }
</script></body></html>
